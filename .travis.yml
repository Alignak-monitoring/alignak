language: python
sudo: required
python:
- '2.7'
- '3.5'
- '3.6'
env:
- TEST_SUITE=unit_tests
- TEST_SUITE=integration
install:
- unset PYTHONWARNINGS
- sudo apt-get install rpm
- sudo pip install virtualenv virtualenv-tools
- sudo pip install --upgrade distribute
- "./test/setup_test.sh"
script:
- pip freeze
- |
  if [[ $TEST_SUITE == 'codingstandard' ]]; then
    # Static code analysis
    # -- pycodestyle (former pep8)
    pycodestyle --max-line-length=100 --exclude='*.pyc,carboniface.py' alignak/* || travis_terminate 1;
    # -- pylint
    unset PYTHONWARNINGS
    pylint --rcfile=.pylintrc -r no alignak || travis_terminate 1;
    export PYTHONWARNINGS=all
    # -- pep257
    pep257 --select=D300 alignak || travis_terminate 1;
  fi
- |
  if [[ $TEST_SUITE == 'unit_tests' ]]; then
    # Run unit tests and code coverage analysis
    cd test
    # Run test suite with py.test running its coverage plugin
    # Dump the 10 slowest tests
    # Do not print log synthesis on test end
    # Get coverage on tests run
    echo "Starting tests..."
    # pytest --verbose --durations=10 --no-print-logs --cov=alignak --cov-config .coveragerc test_*.py || travis_terminate 1;
    pytest --verbose --durations=10 --no-print-logs --cov=alignak --cov-config .coveragerc test_actions.py || travis_terminate 1;
    # Upload coverage results to codecov
    bash <(curl -s https://codecov.io/bash) -e TEST_SUITE
    cd ..
  fi
- ''
- |
  if [[ $TEST_SUITE == 'integration' ]]; then
    # Run load tests and code dynamic analysis
    cd tests_integ
    # Run test suite with py.test running its coverage plugin
    # Dump the 10 slowest tests - do not capture to have some activity in Travis
    # pytest --verbose --durations=10 --no-print-logs --cov=alignak --cov-config .coveragerc test_*.py || travis_terminate 1;
    pytest --verbose --durations=10 --no-print-logs --cov=alignak --cov-config .coveragerc test_launch_arbiter.py || travis_terminate 1;
    # Upload coverage results to codecov
    bash <(curl -s https://codecov.io/bash) -e TEST_SUITE
    cd ..
  fi
after_success:
- |
  if [[ $TEST_SUITE == 'unit_tests' ]]; then
    # Package Alignak for deb/rpm
    ./package.sh $TRAVIS_BRANCH $TRAVIS_PYTHON_VERSION deb;
    ./package.sh $TRAVIS_BRANCH $TRAVIS_PYTHON_VERSION rpm;
    # Not yet available
    # ./package.sh $TRAVIS_BRANCH $TRAVIS_PYTHON_VERSION freebsd;
  fi
notifications:
  webhooks:
    urls:
    - https://webhooks.gitter.im/e/b40202d91150d5c75582
    on_success: change
    on_failure: always
    on_start: never
jobs:
  include:
    - stage: Coding standard
      python: 2.7
      python: 3.6
      script: |
                # Static code analysis
                # -- pycodestyle (former pep8)
                pycodestyle --max-line-length=100 --exclude='*.pyc,carboniface.py' alignak/* || travis_terminate 1;
                # -- pylint
                unset PYTHONWARNINGS
                pylint --rcfile=.pylintrc -r no alignak || travis_terminate 1;
                export PYTHONWARNINGS=all
                # -- pep257
                pep257 --select=D300 alignak || travis_terminate 1;
    - stage: deploy
      python: 3.5
      script: skip
      deploy:
      - provider: pypi
        user: alignak
        password:
          secure: "ka6dbwrBa6d+p/POLiROKraAYT+M2c6CiGB+/b6zL8nCcge1VMsYKtmUrZwXvHzOcYPWiFmI6r5r9TPXBb4vHTIIpIvJ1Ic/MBZi3iQ+0pB+r7Vfzityz68xNPxYNCBts5iBeJ1KTCWtp6PQudKpQlxaZNI9H0PzwybqV7KWut5mkzHoIz+Sc0TvgwTPbI0w3dTvHca8jkwugYce3/oFcBf7QDFjxjsfOmouFOaM5enhgBc0vZ1fnvj2j1VPG64tpbQs5QK7Bb1ZCpsemhRNt08ZRVHd5FK2Gce1ZhKIle+CytPJpg5na9n81ku4s1V7wdSSNDLStdQycL25XI7d669P8JsrVyyi7lwtldafC3/lg49ldoOaovyfR5mBi11E0NO7pRrupTKD/z3qVSMP8+1gkJYFTDx9cBb/wdaqIHQ4yuOcru3PYNb0hlywrqKlzKR65NJj89oBuwu71ux1jkP6Sol4FqRn94jl9GRwX61HyILq3EC95EdtwTm9S9QCUO7wYYHU3TvJ+zLQ2EuPJGXUO78PykBsxreKABV3PTo1wFU+w47UpEZlPetPBusiZDgQcSmmthw8kcb7RntSkWQXZo9XrLmESLkgxekb4RC+LgxyhezwULKjR7F61D423NiruGCHwlim5Mdms+O1lMspbZ2B1f1N1pxvF3y+cB4="
        on:
          branch: develop
          tags: true
      - provider: bintray
        skip_cleanup: true
        file: .bintray-deb.json
        user: mohierf
        key:
          secure: "xcvRMpwT+Gk0F+EpelwxSxixkrgb+XLS2310zj3j7+eQ2ahPD20yKX7sZsvIJs3DQjUtJwTemvgW6Yi7TFFJyYK9UA3csPbSojTonXUULjxLP8J3tmaioC2l0L3g+rzeVRbGdsBg5MBMgiz1xdheA3dlaoadL7UXIKx+ZiIjSIkcQJNZWUAPtgsnHGpNx94YGDv4zKp9sBm1Y34QPY8sRXRdlYfmBtp1k1wXVqiVk0K81c6PYoL7bGg9tywfZCGAlhzW0F4Dq9GsB+J1aKgT/QnNVS3HKID8W3wXmlIqGfiidECKjRgZuKcC7ayinuGTOhlitPRtlsAs55Suq7EbAUu4SF8QKV8q5wjtdVxln3zxLrJTAAG2rHQYI4JICjUtPocajZd5661IdHu/UnhqKKWcORK00zwTiQqly9Px/FN0C1qCmnz+1nZOECAQpUxUUXISgKQhYHFKCQK3V4DMryPzPsDuvq4aAIrjjzedca1QwC8FvQgRE13TyLm9wtgsCCZ2TM5moigY37Ea1Gw0leDnAnx6sN5ZERLRE59VxWjhO5O617+kuvxlOcAwkiRYtUPuCVlv00TySqKxtjlY9Rkpc1YLqiLiYJQYCm7ubcFMje9Cy6c8xzS0kTO7HBdPbfJ9ODEKHpOZLYD39iOUk/T60IWMIvsM1RhLTVr7z5Y="
        on:
          branch: develop
      - provider: bintray
        skip_cleanup: true
        file: .bintray-deb.json
        user: mohierf
        key:
          secure: "xcvRMpwT+Gk0F+EpelwxSxixkrgb+XLS2310zj3j7+eQ2ahPD20yKX7sZsvIJs3DQjUtJwTemvgW6Yi7TFFJyYK9UA3csPbSojTonXUULjxLP8J3tmaioC2l0L3g+rzeVRbGdsBg5MBMgiz1xdheA3dlaoadL7UXIKx+ZiIjSIkcQJNZWUAPtgsnHGpNx94YGDv4zKp9sBm1Y34QPY8sRXRdlYfmBtp1k1wXVqiVk0K81c6PYoL7bGg9tywfZCGAlhzW0F4Dq9GsB+J1aKgT/QnNVS3HKID8W3wXmlIqGfiidECKjRgZuKcC7ayinuGTOhlitPRtlsAs55Suq7EbAUu4SF8QKV8q5wjtdVxln3zxLrJTAAG2rHQYI4JICjUtPocajZd5661IdHu/UnhqKKWcORK00zwTiQqly9Px/FN0C1qCmnz+1nZOECAQpUxUUXISgKQhYHFKCQK3V4DMryPzPsDuvq4aAIrjjzedca1QwC8FvQgRE13TyLm9wtgsCCZ2TM5moigY37Ea1Gw0leDnAnx6sN5ZERLRE59VxWjhO5O617+kuvxlOcAwkiRYtUPuCVlv00TySqKxtjlY9Rkpc1YLqiLiYJQYCm7ubcFMje9Cy6c8xzS0kTO7HBdPbfJ9ODEKHpOZLYD39iOUk/T60IWMIvsM1RhLTVr7z5Y="
        on:
          tags: true
      - provider: bintray
        skip_cleanup: true
        file: .bintray-rpm.json
        user: mohierf
        key:
          secure: "xcvRMpwT+Gk0F+EpelwxSxixkrgb+XLS2310zj3j7+eQ2ahPD20yKX7sZsvIJs3DQjUtJwTemvgW6Yi7TFFJyYK9UA3csPbSojTonXUULjxLP8J3tmaioC2l0L3g+rzeVRbGdsBg5MBMgiz1xdheA3dlaoadL7UXIKx+ZiIjSIkcQJNZWUAPtgsnHGpNx94YGDv4zKp9sBm1Y34QPY8sRXRdlYfmBtp1k1wXVqiVk0K81c6PYoL7bGg9tywfZCGAlhzW0F4Dq9GsB+J1aKgT/QnNVS3HKID8W3wXmlIqGfiidECKjRgZuKcC7ayinuGTOhlitPRtlsAs55Suq7EbAUu4SF8QKV8q5wjtdVxln3zxLrJTAAG2rHQYI4JICjUtPocajZd5661IdHu/UnhqKKWcORK00zwTiQqly9Px/FN0C1qCmnz+1nZOECAQpUxUUXISgKQhYHFKCQK3V4DMryPzPsDuvq4aAIrjjzedca1QwC8FvQgRE13TyLm9wtgsCCZ2TM5moigY37Ea1Gw0leDnAnx6sN5ZERLRE59VxWjhO5O617+kuvxlOcAwkiRYtUPuCVlv00TySqKxtjlY9Rkpc1YLqiLiYJQYCm7ubcFMje9Cy6c8xzS0kTO7HBdPbfJ9ODEKHpOZLYD39iOUk/T60IWMIvsM1RhLTVr7z5Y="
        on:
          tags: true
# Not yet available
#  - provider: bintray
#    skip_cleanup: true
#    file: .bintray-freebsd.json
#    user: mohierf
#    key:
#      secure: "xcvRMpwT+Gk0F+EpelwxSxixkrgb+XLS2310zj3j7+eQ2ahPD20yKX7sZsvIJs3DQjUtJwTemvgW6Yi7TFFJyYK9UA3csPbSojTonXUULjxLP8J3tmaioC2l0L3g+rzeVRbGdsBg5MBMgiz1xdheA3dlaoadL7UXIKx+ZiIjSIkcQJNZWUAPtgsnHGpNx94YGDv4zKp9sBm1Y34QPY8sRXRdlYfmBtp1k1wXVqiVk0K81c6PYoL7bGg9tywfZCGAlhzW0F4Dq9GsB+J1aKgT/QnNVS3HKID8W3wXmlIqGfiidECKjRgZuKcC7ayinuGTOhlitPRtlsAs55Suq7EbAUu4SF8QKV8q5wjtdVxln3zxLrJTAAG2rHQYI4JICjUtPocajZd5661IdHu/UnhqKKWcORK00zwTiQqly9Px/FN0C1qCmnz+1nZOECAQpUxUUXISgKQhYHFKCQK3V4DMryPzPsDuvq4aAIrjjzedca1QwC8FvQgRE13TyLm9wtgsCCZ2TM5moigY37Ea1Gw0leDnAnx6sN5ZERLRE59VxWjhO5O617+kuvxlOcAwkiRYtUPuCVlv00TySqKxtjlY9Rkpc1YLqiLiYJQYCm7ubcFMje9Cy6c8xzS0kTO7HBdPbfJ9ODEKHpOZLYD39iOUk/T60IWMIvsM1RhLTVr7z5Y="
#    on:
#      tags: true
